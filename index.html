<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cozy Crochet</title>

<style>
:root{
  --bg:#0f0b17;
  --panel:#1b132a;
  --panel-soft:#24183a;
  --accent:#b388ff;
  --text:#f6f3ff;
  --muted:#b9aee8;
}

body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:system-ui,sans-serif;
}

#ui{
  background:var(--panel);
  padding:10px 12px;
  display:flex;
  justify-content:space-between;
  font-size:13px;
}

#controls{
  background:var(--panel-soft);
  padding:10px 12px;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}

select{
  background:#120c1f;
  color:var(--text);
  border:1px solid #3a2a66;
  border-radius:8px;
  padding:6px;
}

#game{
  width:100vw;
  height:45vh;
  display:block;
  background:radial-gradient(circle at top,#1d1335,#0f0b17);
}

#tutorial{
  margin:10px;
  background:#24183a;
  padding:12px;
  border-radius:12px;
  font-size:14px;
}

#touchControls{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:10px;
  padding:12px;
  background:var(--panel-soft);
}

#touchControls button{
  padding:16px;
  font-size:15px;
  border:none;
  border-radius:14px;
  background:linear-gradient(180deg,#5e3fa6,#3b2a66);
  color:white;
}

#celebration{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(15,11,23,.92);
  align-items:center;
  justify-content:center;
  flex-direction:column;
  text-align:center;
}

#celebration canvas{
  margin-top:10px;
  background:radial-gradient(circle,#1d1335,#0f0b17);
  border-radius:16px;
}
</style>
</head>

<body>

<audio id="bgm" src="music.mp3" loop></audio>

<div id="ui">
  <div id="left"></div>
  <div id="right"></div>
</div>

<div id="controls">
  Object:
  <select id="object">
    <option value="square">Square</option>
    <option value="scarf">Scarf</option>
    <option value="patch">Patch</option>
    <option value="heart">Heart</option>
    <option value="star">Star</option>
    <option value="plush">Plush Panel</option>
    <option value="beanie">Beanie</option>
  </select>

  Yarn:
  <select id="yarn">
    <option value="#b388ff">Lavender</option>
    <option value="#ff8bd7">Pink Glow</option>
    <option value="#7cf0ff">Moon Blue</option>
    <option value="#f2c94c">Gold</option>
  </select>
</div>

<canvas id="game"></canvas>

<div id="tutorial"></div>

<div id="touchControls">
  <button onclick="press('A')">Insert</button>
  <button onclick="press('W')">Yarn</button>
  <button onclick="press('D')">Pull</button>
  <button onclick="press('S')">Tighten</button>
  <button onclick="press('Space')">Finish</button>
  <button onclick="press('Backspace')">Undo</button>
</div>

<div id="celebration" onclick="closeCelebration()">
  <h2 id="rewardTitle">Good job! ðŸ’œ</h2>
  <p>You made something cozy âœ¨</p>
  <canvas id="celebrationCanvas" width="300" height="300"></canvas>
  <p>Tap to continue</p>
</div>

<script>
/* ================= CANVAS ================= */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

function resize(){
  const r = canvas.getBoundingClientRect();
  const dpr = window.devicePixelRatio || 1;
  canvas.width = r.width * dpr;
  canvas.height = r.height * dpr;
  ctx.setTransform(dpr,0,0,dpr,0,0);
}
window.addEventListener("resize", resize);
resize();

/* ================= MUSIC ================= */
const bgm = document.getElementById("bgm");
bgm.volume = 0.35;
function startMusic(){
  if(bgm.paused) bgm.play().catch(()=>{});
}

/* ================= STITCH COMBOS ================= */
const STITCHES = {
  chain:["W","D","Space"],
  single:["A","W","D","S","Space"],
  double:["W","W","A","D","S","Space"]
};

/* ================= OBJECT SHAPES ================= */
const OBJECTS = {
  square:{name:"Granny Square",w:8,h:8},
  scarf:{name:"Cozy Scarf",w:6,h:12},
  patch:{name:"Patch",w:5,h:5},
  plush:{name:"Plush Panel",w:7,h:12},
  heart:{name:"Heart",w:7,h:7,mask:(r,c)=>Math.abs(c-3)+r<6},
  star:{name:"Star",w:9,h:9,mask:(r,c)=>r%2||c%2},
  beanie:{name:"Beanie",w:9,h:6,mask:(r,c)=>r>1 && Math.abs(c-4)<r}
};

/* ================= GAME STATE ================= */
const game = {
  yarn:"#b388ff",
  object:"square",
  pattern:[],
  index:0,
  buffer:[],
  fabric:[],
  finished:false
};

/* ================= INPUT ================= */
function press(k){
  startMusic();
  if(game.finished) return;

  if(k==="Backspace"){
    undo();
    return;
  }

  game.buffer.push(k);
  checkCombo();
}

window.addEventListener("keydown", e=>{
  const map = {a:"A",w:"W",s:"S",d:"D"," ":"Space",Backspace:"Backspace"};
  if(map[e.key]){
    e.preventDefault();
    press(map[e.key]);
  }
});

/* ================= PATTERN ================= */
function generatePattern(){
  game.pattern = [];
  game.index = 0;
  const o = OBJECTS[game.object];
  const types = ["chain","single","double"];
  let t = 0;

  for(let r=0;r<o.h;r++){
    for(let c=0;c<o.w;c++){
      if(!o.mask || o.mask(r,c)){
        game.pattern.push({row:r,col:c,type:types[t % types.length]});
        t++;
      }
    }
  }
}

/* ================= COMBO LOGIC ================= */
function checkCombo(){
  const target = game.pattern[game.index];
  if(!target) return;

  const combo = STITCHES[target.type];

  for(let i=0;i<game.buffer.length;i++){
    if(game.buffer[i] !== combo[i]){
      game.buffer = [];
      return;
    }
  }

  if(game.buffer.length === combo.length){
    complete();
  }
}

function complete(){
  game.fabric.push(game.pattern[game.index]);
  game.index++;
  game.buffer = [];
  if(game.index >= game.pattern.length) finish();
}

function undo(){
  if(game.index===0) return;
  game.index--;
  game.fabric.pop();
  game.buffer=[];
}

/* ================= FINISH ================= */
function finish(){
  game.finished = true;
  showCelebration();
}

/* ================= DRAWING ================= */
function drawYarn(x,y){
  ctx.strokeStyle = game.yarn;
  ctx.lineWidth = 6;
  ctx.shadowColor = game.yarn;
  ctx.shadowBlur = 10;
  ctx.beginPath();
  ctx.moveTo(x-10,y+10);
  ctx.quadraticCurveTo(x,y-10,x+10,y+10);
  ctx.stroke();
  ctx.shadowBlur = 0;
}

function drawHook(x,y){
  ctx.strokeStyle = "#fff";
  ctx.lineWidth = 5;
  ctx.lineCap = "round";
  ctx.beginPath();
  ctx.moveTo(x-14,y-24);
  ctx.lineTo(x+6,y+6);
  ctx.stroke();
}

function render(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const ox = canvas.clientWidth/2 - 80;
  const oy = canvas.clientHeight/2 + 60;

  game.fabric.forEach(s=>{
    drawYarn(ox + s.col*24, oy - s.row*24);
  });

  if(!game.finished){
    const t = game.pattern[game.index];
    if(t) drawHook(ox + t.col*24, oy - t.row*24);
  }

  requestAnimationFrame(render);
}
render();

/* ================= UI ================= */
function updateUI(){
  const t = game.pattern[game.index];
  if(!t){ tutorial.textContent=""; return; }
  const combo = STITCHES[t.type];
  tutorial.innerHTML =
    `<b>${t.type.toUpperCase()} stitch</b><br>
     Next: <strong>${combo[game.buffer.length] || "â€”"}</strong>`;
  left.textContent = `Object: ${game.object}`;
  right.textContent = `Stitch ${game.index+1} / ${game.pattern.length}`;
}
setInterval(updateUI,120);

/* ================= REWARDS ================= */
const REWARDS = {
  square:cx=>drawSquare(cx),
  scarf:cx=>drawScarf(cx),
  heart:cx=>drawHeart(cx),
  star:cx=>drawStar(cx),
  plush:cx=>drawPlush(cx),
  beanie:cx=>drawBeanie(cx)
};

function drawSquare(cx){
  cx.fillStyle = game.yarn;
  cx.shadowColor = game.yarn;
  cx.shadowBlur = 20;
  cx.beginPath();
  cx.roundRect(80,80,140,140,20);
  cx.fill();
  cx.shadowBlur=0;
}

function drawScarf(cx){
  cx.strokeStyle = game.yarn;
  cx.lineWidth = 18;
  cx.lineCap = "round";
  cx.beginPath();
  cx.moveTo(120,40);
  cx.quadraticCurveTo(200,160,160,260);
  cx.stroke();
  cx.beginPath();
  cx.moveTo(170,40);
  cx.quadraticCurveTo(250,160,200,260);
  cx.stroke();
}

function drawHeart(cx){
  cx.fillStyle = game.yarn;
  cx.beginPath();
  cx.moveTo(150,210);
  cx.bezierCurveTo(60,130,80,60,150,100);
  cx.bezierCurveTo(220,60,240,130,150,210);
  cx.fill();
}

function drawStar(cx){
  cx.fillStyle = game.yarn;
  cx.beginPath();
  cx.moveTo(150,40);
  for(let i=0;i<5;i++){
    cx.lineTo(150+60*Math.cos((18+i*72)*Math.PI/180),
              150-60*Math.sin((18+i*72)*Math.PI/180));
    cx.lineTo(150+25*Math.cos((54+i*72)*Math.PI/180),
              150-25*Math.sin((54+i*72)*Math.PI/180));
  }
  cx.closePath();
  cx.fill();
}

function drawPlush(cx){
  cx.fillStyle = game.yarn;
  cx.beginPath();
  cx.roundRect(90,70,120,160,30);
  cx.fill();
}

function drawBeanie(cx){
  cx.fillStyle = game.yarn;
  cx.beginPath();
  cx.arc(150,160,90,Math.PI,0);
  cx.fill();
  cx.fillRect(60,160,180,30);
  cx.beginPath();
  cx.arc(150,70,10,0,Math.PI*2);
  cx.fill();
}

/* ================= CELEBRATION ================= */
function showCelebration(){
  rewardTitle.textContent = `You made a ${OBJECTS[game.object].name}! ðŸ§¶âœ¨`;
  const c = document.getElementById("celebrationCanvas");
  const cx = c.getContext("2d");
  cx.clearRect(0,0,c.width,c.height);
  if(REWARDS[game.object]) REWARDS[game.object](cx);
  celebration.style.display = "flex";
}

function closeCelebration(){
  celebration.style.display = "none";
  start();
}

/* ================= START ================= */
function start(){
  game.object = object.value;
  game.yarn = yarn.value;
  game.buffer = [];
  game.fabric = [];
  game.finished = false;
  generatePattern();
}

object.onchange = start;
yarn.onchange = start;
start();
</script>

</body>
</html>
